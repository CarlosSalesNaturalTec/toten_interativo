<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversar - Toten Interativo</title>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <script src="js/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="src/config.js"></script>

    <style>
        /* CSS para centralizar a div */
        .centralizada {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            /* Altura total da viewport */
        }

        .conteudo {
            width: 50%;
            /* Largura da div */
            text-align: center;
        }

        #rodape {
            position: fixed;
            /* Fixa a div em relação à janela do navegador */
            right: 0;
            /* Alinha a div à direita */
            bottom: 0;
            /* Alinha a div à parte inferior */
            text-align: right;
            font-size: 12px;
            padding: 10px;
        }
    </style>

</head>

<body>

    <div id="divMenu" class="container centralizada">
        <div class="conteudo">
            <img id="divImageImg" src="image/wavesOff.gif" alt="Imagem de ondas sonoras"><br>
            <br>
            <div id="divButtons" class="d-grid gap-2" style="visibility: hidden;">
                <button type="button" class="btn btn-success" onclick="speech()">Responder</button>
                <button type="button" class="btn btn-outline-dark" onclick="cancel()">Voltar</button>
            </div>
            <br>
            <div id="output"></div>
        </div>
    </div>

    <script>

        const areaMensagens = document.getElementById("output");

        //#region - Síntese de Voz e Reconhecimento de fala 
        const synth = window.speechSynthesis;
        var interactionMsg = "";
        var pitch = messages.pitch; // entonação de voz padrão
        var rate = messages.rate;   // velocidade de fala padrão

        var resultRecognition;
        var recognitionAction;
        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Recurso de reconhecimento de fala não disponível neste Browser. Verifique permissões ou utilize outro navegador");
        }
        recognition = new SpeechRecognition();
        recognition.continuous = false;      // Reconhecimento contínuo em loop
        recognition.interimResults = false; // resultados parciais
        recognition.lang = "pt-BR";

        recognition.onstart = function (e) {
            console.log("Reconhecimento de fala INICIADO");
        };

        recognition.onsoundstart = function (e) {
            console.log("Som detectado!");
        };

        recognition.onresult = function (e) {
            document.getElementById("divButtons").style.visibility = "visible";
            var resultIndex = e.resultIndex
            exibirmensagem(e.results[resultIndex][0].transcript);
        };

        recognition.onspeechend = function (e) {
            console.log("onspeechend");
        };

        recognition.onerror = function (e) {
            console.log('onError', e);
            exibirmensagem("Ocorreu um erro : " + e.error);
        };

        recognition.onend = function (e) {
            console.log("onend");
        };
        //#endregion

        function speak() {
            const utterThis = new SpeechSynthesisUtterance(interactionMsg);
            utterThis.onstart = function () {
                document.getElementById("divImageImg").src = "image/wavesOn.gif";
                document.getElementById("divButtons").style.visibility = "hidden";
            };
            utterThis.onend = function () {
                document.getElementById("divImageImg").src = "image/wavesOff.gif";
                document.getElementById("divButtons").style.visibility = "visible";
            };
            utterThis.pitch = pitch;
            utterThis.rate = rate;
            synth.speak(utterThis);
        }

        function speakStop() {
            synth.cancel();
        }

        function speech() {
            document.getElementById("divButtons").style.visibility = "hidden";
            startSpeechRecognition('');
        }

        function startSpeechRecognition(param) {
            // param = eventual ação a ser executada após recebimento de audio/resposta
            speakStop();
            recognitionAction = param;
            resultRecognition = "";
            recognition.start();
        }

        function exibirmensagem(mensagem) {
            areaMensagens.innerHTML += mensagem + "</br>";
        }

        function cancel() {
            speakStop();
            window.location.href = "menu.html";
        }

        $(document).ready(function () {
            interactionMsg = messages.input_name;
            speak();
        });

    </script>

</body>

</html>